<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SmitsInterconnect - Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f8ff;
            font-family: 'Arial', sans-serif;
        }

        .header {
            background-color: #fff;
            padding: 10px 30px;
            font-size: 20px;
            font-weight: bold;
            color: #009;
        }

        .nav-bar {
            display: flex;
            border-bottom: 3px solid black;
            background-color: #B5E3FC;
        }

        .nav-link-custom {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            color: black;
            border: none;
            transition: background-color 0.3s ease;
        }

        .nav-link-custom:hover {
            background-color: #8acdfc;
        }

        .nav-link-custom.active {
            background-color: #08A4F8;
            font-weight: bold;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-top: 30px;
            text-align: center;
        }

        .section-subtitle {
            display: inline-block;
            border: 2px solid black;
            padding: 5px 25px;
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }

        .temperature {
            margin-top: 20px;
            font-size: 18px;
        }

        .fan-card {
            border: 2px solid black;
            padding: 15px;
            position: relative;
            text-align: center;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .icon-row {
            display: flex;
            justify-content: space-around;
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
        }

        .icon-row .icon-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0 5px;
            position: relative; /* Necesario para posicionar el badge */
        }

        .icon-row .icon-btn:hover {
            color: #08A4F8;
        }

        /* Estilo para el badge de alerta en el icono de herramientas */
        .maintenance-alert-badge {
            position: absolute;
            top: -2px; /* Ajusta la posición vertical */
            right: -2px; /* Ajusta la posición horizontal */
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            display: none; /* Oculto por defecto */
            border: 2px solid white; /* Pequeño borde blanco para visibilidad */
        }

        .fan-icon {
            font-size: 60px;
            margin: 40px 0 10px;
        }

        .fan-label {
            font-size: 14px;
            font-weight: bold;
            text-align: left;
        }

        .btn-plan {
            margin-top: 10px;
            border: 2px solid black;
            background-color: #08A4F8;
            color: white;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .btn-plan:hover {
            background-color: #007bff;
            color: white;
        }

        /* Estilos para los botones de mantenimiento */
        .maintenance-button {
            width: 80%;
            margin: 15px auto;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid #000;
            background-color: #B5E3FC;
            color: #000;
            transition: background-color 0.3s ease, color 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .maintenance-button:hover {
            background-color: #08A4F8;
            color: white;
        }

        /* Estilo para la flecha de regreso */
        .back-arrow {
            position: absolute;
            top: 70px; /* Ajustado para bajar la flecha */
            left: 20px;
            font-size: 30px;
            color: #333;
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 10;
        }

        .back-arrow:hover {
            color: #08A4F8;
        }

        /* Ocultar secciones por defecto */
        .content-section {
            display: none;
        }

        /* Estilo para el botón flotante de "Registrar Mantenimiento" */
        .floating-add-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #08A4F8;
            color: white;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
            z-index: 1000;
        }

        .floating-add-btn:hover {
            background-color: #007bff;
        }

        /* Estilos específicos para la tabla de historial */
        #historial-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #historial-content th, #historial-content td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #historial-content th {
            background-color: #f2f2f2;
        }

        #historial-content .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }

        #historial-content .search-bar {
            margin-bottom: 15px;
        }

        /* Estilos para el formulario de registrar */
        #registrar-content .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        #registrar-content label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        #registrar-content select, #registrar-content input[type="date"],
        #registrar-content input[type="text"], #registrar-content input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #registrar-content .btn-submit {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }

        #registrar-content .btn-submit:hover {
            background-color: #218838;
        }

        /* Estilos para planes de mantenimiento */
        #planes-content .air-select-container {
            margin-bottom: 20px;
            text-align: left;
        }

        /* Estilo para las secciones de planes (similar a la imagen) */
        .plan-section-box {
            border: 2px solid black;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
        }

        .plan-section-box h4 {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Estilo para el plan de mantenimiento individual (similar a la imagen) */
        .single-plan-entry {
            display: flex;
            border: 1px solid #000;
            margin-bottom: 5px;
            text-align: left;
        }

        .single-plan-entry .plan-date-col {
            flex: 0 0 120px; /* Ancho fijo para la fecha */
            padding: 8px;
            border-right: 1px solid #000;
            font-weight: bold;
            background-color: #f2f2f2; /* Un poco de sombreado para la fecha */
        }

        .single-plan-entry .plan-type-col {
            flex-grow: 1;
            padding: 8px;
        }

        /* Estilo para la lista de futuros mantenimientos */
        .future-plans-list {
            max-height: 250px; /* Altura máxima para la lista con scroll */
            overflow-y: auto;
            border: 1px solid #ccc; /* Borde para la lista, si se desea */
        }

        /* Resaltar planes próximos o atrasados */
        .single-plan-entry.due-soon {
            background-color: #fff8e1; /* Fondo amarillo claro */
            border-left: 4px solid orange;
        }
        .single-plan-entry.overdue {
            background-color: #ffebee; /* Fondo rojo claro */
            border-left: 4px solid red;
        }

    </style>
</head>
<body>

    <div class="header">
        <img src="img/smiths_interconnect.png" alt="Smiths Interconnect" style="max-height: 20px;">
    </div>

    <div class="nav-bar">
        <a href="#monitor" class="nav-link-custom active" id="monitor-tab">Monitor</a>
        <a href="#mantenimiento" class="nav-link-custom" id="mantenimiento-tab">Mantenimiento</a>
    </div>

    <div id="monitor-section" class="container text-center mt-4 content-section active-section">
        <div class="section-title">Monitor</div>
        <div class="section-subtitle">Área de producción</div>
        <p class="temperature"> 🌡 Temperatura actual: <span id="current-temperature">__</span> °C</p>

        <div class="row justify-content-center mt-4">
            <div class="col-md-4 m-2">
                <div class="fan-card">
                    <div class="fan-label">A1</div>
                    <div class="icon-row">
                        <button class="icon-btn" title="Historial A1">
                            <i class="bi bi-tools"></i>
                            <span class="maintenance-alert-badge" id="alert-a1-tools"></span>
                        </button>
                        <button class="icon-btn" title="Alerta A1"><i class="bi bi-exclamation-triangle"></i></button>
                    </div>
                    <div class="fan-icon">
                        <img src="img/ventilador.png" alt="Ventilador" class="img-fluid" style="max-height: 120px;">
                    </div>
                    <p class="mt-2 mb-0">Estado: <span id="status-a1" class="fw-bold text-success">Encendido</span></p>
                    <button class="btn btn-outline-dark btn-sm btn-plan mt-3" onclick="showPlanes('A1')">Plan de mantenimiento</button>
                </div>
            </div>

            <div class="col-md-4 m-2">
                <div class="fan-card">
                    <div class="fan-label">A2</div>
                    <div class="icon-row">
                        <button class="icon-btn" title="Historial A2">
                            <i class="bi bi-tools"></i>
                            <span class="maintenance-alert-badge" id="alert-a2-tools"></span>
                        </button>
                        <button class="icon-btn" title="Alerta A2"><i class="bi bi-exclamation-triangle"></i></button>
                    </div>
                    <div class="fan-icon">
                        <img src="img/ventilador.png" alt="Ventilador" class="img-fluid" style="max-height: 120px;">
                    </div>
                    <p class="mt-2 mb-0">Estado: <span id="status-a2" class="fw-bold text-danger">Apagado</span></p>
                    <button class="btn btn-outline-dark btn-sm btn-plan mt-3" onclick="showPlanes('A2')">Plan de mantenimiento</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mantenimiento-section" class="container text-center mt-5 content-section">
        <div class="section-title">Opciones de Mantenimiento</div>
        <div class="row justify-content-center mt-4">
            <div class="col-12">
                <button class="btn maintenance-button" onclick="showContent('historial')">Historial</button>
            </div>
            <div class="col-12">
                <button class="btn maintenance-button" onclick="showContent('registrar')">Registrar</button>
            </div>
            <div class="col-12">
                <button class="btn maintenance-button" onclick="showContent('planes')">Planes de Mantenimiento</button>
            </div>
        </div>
    </div>

    <div id="historial-content" class="container mt-5 content-section">
        <i class="bi bi-arrow-left back-arrow" onclick="goBackToMantenimiento()" title="Regresar"></i>
        <h2 class="text-center mb-4">Historial de Mantenimientos</h2>

        <div class="input-group mb-3 search-bar">
            <input type="text" class="form-control" placeholder="Buscar por fecha, aire, supervisor..." id="historial-search">
            <button class="btn btn-outline-secondary" type="button" id="button-search">Buscar</button>
        </div>

        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Aire</th>
                        <th>Tipo de Mantenimiento</th>
                        <th>Supervisor</th>
                        <th>Archivo</th>
                    </tr>
                </thead>
                <tbody id="historial-table-body">
                    <tr>
                        <td>2024-05-20</td>
                        <td>A1</td>
                        <td>Preventivo (3 Meses)</td>
                        <td>Juan Pérez</td>
                        <td><a href="#">Ver archivo</a></td>
                    </tr>
                    <tr>
                        <td>2024-05-15</td>
                        <td>A2</td>
                        <td>Emergencia</td>
                        <td>Ana García</td>
                        <td><a href="#">Ver archivo</a></td>
                    </tr>
                     <tr>
                        <td>2024-05-10</td>
                        <td>A1</td>
                        <td>Correctivo</td>
                        <td>Carlos Ruíz</td>
                        <td><a href="#">Ver archivo</a></td>
                    </tr>
                     <tr>
                        <td>2024-05-01</td>
                        <td>A2</td>
                        <td>Preventivo (6 Meses)</td>
                        <td>Juan Pérez</td>
                        <td><a href="#">Ver archivo</a></td>
                    </tr>
                    <tr>
                        <td>2024-04-25</td>
                        <td>A1</td>
                        <td>Emergencia</td>
                        <td>Ana García</td>
                        <td><a href="#">Ver archivo</a></td>
                    </tr>
                     <tr>
                        <td>2024-04-18</td>
                        <td>A2</td>
                        <td>Preventivo (3 Meses)</td>
                        <td>Carlos Ruíz</td>
                        <td><a href="#">Ver archivo</a></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3 class="text-center mt-5 mb-3">Gráfica de Tipos de Mantenimiento</h3>
        <div class="chart-container" style="width: 80%; margin: auto;">
            <canvas id="mantenimientoChart"></canvas>
        </div>
    </div>

    <div id="registrar-content" class="container mt-5 content-section">
        <i class="bi bi-arrow-left back-arrow" onclick="goBackToMantenimiento()" title="Regresar"></i>
        <h2 class="text-center mb-4">Registrar Nuevo Mantenimiento</h2>
        <form id="registro-form">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="fechaMantenimiento">Fecha:</label>
                        <input type="date" class="form-control" id="fechaMantenimiento" required>
                    </div>
                    <div class="form-group">
                        <label for="aireSeleccionado">Aire:</label>
                        <select class="form-select" id="aireSeleccionado" required>
                            <option value="">Selecciona un aire</option>
                            <option value="A1">A1</option>
                            <option value="A2">A2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoMantenimiento">Tipo de Mantenimiento:</label>
                        <select class="form-select" id="tipoMantenimiento" required>
                            <option value="">Selecciona el tipo</option>
                            <option value="Preventivo (3 Meses)">Preventivo (3 Meses)</option>
                            <option value="Preventivo (6 Meses)">Preventivo (6 Meses)</option>
                            <option value="Correctivo">Correctivo</option>
                            <option value="Emergencia">Emergencia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="supervisor">Supervisor:</label>
                        <input type="text" class="form-control" id="supervisor" placeholder="Nombre del supervisor" required>
                    </div>
                    <div class="form-group">
                        <label for="archivoMantenimiento">Subir Archivo:</label>
                        <input type="file" class="form-control" id="archivoMantenimiento">
                    </div>
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-success btn-submit">Registrar Mantenimiento</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="planes-content" class="container mt-5 content-section">
        <i class="bi bi-arrow-left back-arrow" onclick="goBackToMantenimiento()" title="Regresar"></i>
        <h2 class="text-center mb-4">Planes de Mantenimiento</h2>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="air-select-container">
                    <label for="selectAirPlan" class="form-label">Selecciona el Aire:</label>
                    <select class="form-select" id="selectAirPlan" onchange="displayMaintenancePlans()">
                        <option value="">Todos los aires</option>
                        <option value="A1">A1</option>
                        <option value="A2">A2</option>
                    </select>
                </div>

                <div class="plan-section-box mb-4">
                    <h4 class="text-center">Próximo mantenimiento</h4>
                    <div id="next-maintenance-display">
                        <p class="text-center">Selecciona un aire o no hay mantenimientos próximos.</p>
                    </div>
                </div>

                <div class="plan-section-box">
                    <h4 class="text-center">Futuros mantenimientos</h4>
                    <div id="future-maintenances-display" class="future-plans-list">
                        <p class="text-center">Selecciona un aire para ver los mantenimientos futuros.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <button class="floating-add-btn" onclick="showContent('registrar')">
        <i class="bi bi-plus"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Referencias a las secciones principales
        const monitorSection = document.getElementById('monitor-section');
        const mantenimientoSection = document.getElementById('mantenimiento-section');

        // Referencias a las sub-secciones de mantenimiento
        const historialContent = document.getElementById('historial-content');
        const registrarContent = document.getElementById('registrar-content');
        const planesContent = document.getElementById('planes-content');

        // Referencias a las pestañas de navegación
        const monitorTab = document.getElementById('monitor-tab');
        const mantenimientoTab = document.getElementById('mantenimiento-tab');

        // Referencia al botón flotante de agregar
        const floatingAddBtn = document.querySelector('.floating-add-btn');

        // Función para formatear fechas a DD/MM/YYYY
        function formatDateToDDMMYYYY(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Añadir T00:00:00 para evitar problemas de zona horaria
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-index
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Función para mostrar/ocultar secciones
        function showSection(sectionToShow) {
            const sections = [monitorSection, mantenimientoSection, historialContent, registrarContent, planesContent];
            sections.forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active-section');
            });

            sectionToShow.style.display = 'block';
            sectionToShow.classList.add('active-section');

            // Control del botón flotante
            if (sectionToShow === monitorSection || sectionToShow === mantenimientoSection) {
                floatingAddBtn.style.display = 'block';
            } else {
                floatingAddBtn.style.display = 'none';
            }
        }

        // Event Listeners para las pestañas de navegación
        monitorTab.addEventListener('click', () => {
            showSection(monitorSection);
            monitorTab.classList.add('active');
            mantenimientoTab.classList.remove('active');
            checkMaintenanceAlerts(); // Vuelve a verificar las alertas al cambiar al monitor
        });

        mantenimientoTab.addEventListener('click', () => {
            showSection(mantenimientoSection);
            mantenimientoTab.classList.add('active');
            monitorTab.classList.remove('active');
        });

        // Función para mostrar el contenido específico de Mantenimiento (Historial, Registrar, Planes)
        function showContent(contentId) {
            showSection(document.getElementById(contentId + '-content'));
            monitorTab.style.display = 'none';
            mantenimientoTab.style.display = 'none';

            if (contentId === 'historial') {
                updateMaintenanceChart();
            }
            if (contentId === 'planes') {
                // Asegurarse de que el select de aire esté vacío por defecto al entrar
                document.getElementById('selectAirPlan').value = "";
                displayMaintenancePlans();
            }
        }

        // Función para regresar a la sección principal de Mantenimiento
        function goBackToMantenimiento() {
            showSection(mantenimientoSection);
            monitorTab.style.display = '';
            mantenimientoTab.style.display = '';
            mantenimientoTab.classList.add('active');
            monitorTab.classList.remove('active');
            void monitorTab.offsetWidth;
            void mantenimientoTab.offsetWidth;
        }

        // Función para mostrar planes directamente desde la tarjeta del aire
        function showPlanes(airId) {
            showContent('planes');
            document.getElementById('selectAirPlan').value = airId;
            displayMaintenancePlans();
        }


        // --- Lógica para Historial ---
        const historialTableBody = document.getElementById('historial-table-body');
        const historialSearch = document.getElementById('historial-search');

        // Datos de ejemplo para el historial (puedes reemplazarlos con datos reales de tu backend)
        let maintenanceHistory = [
            { fecha: '2025-05-20', aire: 'A1', tipo: 'Preventivo (3 Meses)', supervisor: 'Juan Pérez', archivo: '#' },
            { fecha: '2025-05-15', aire: 'A2', tipo: 'Emergencia', supervisor: 'Ana García', archivo: '#' },
            { fecha: '2025-05-10', aire: 'A1', tipo: 'Correctivo', supervisor: 'Carlos Ruíz', archivo: '#' },
            { fecha: '2025-05-01', aire: 'A2', tipo: 'Preventivo (6 Meses)', supervisor: 'Juan Pérez', archivo: '#' },
            { fecha: '2025-04-25', aire: 'A1', tipo: 'Emergencia', supervisor: 'Ana García', archivo: '#' },
            { fecha: '2025-04-18', aire: 'A2', tipo: 'Preventivo (3 Meses)', supervisor: 'Carlos Ruíz', archivo: '#' },
            { fecha: '2025-04-10', aire: 'A1', tipo: 'Preventivo (3 Meses)', supervisor: 'Laura López', archivo: '#' },
            { fecha: '2025-03-20', aire: 'A2', tipo: 'Emergencia', supervisor: 'Pedro Gómez', archivo: '#' },
            { fecha: '2025-03-05', aire: 'A1', tipo: 'Correctivo', supervisor: 'Marta Díaz', archivo: '#' },
            { fecha: '2025-02-15', aire: 'A2', tipo: 'Preventivo (6 Meses)', supervisor: 'Juan Pérez', archivo: '#' },
            { fecha: '2025-01-30', aire: 'A1', tipo: 'Preventivo (3 Meses)', supervisor: 'Ana García', archivo: '#' },
            { fecha: '2025-01-05', aire: 'A2', tipo: 'Emergencia', supervisor: 'Carlos Ruíz', archivo: '#' },
        ];

        function renderHistorialTable(data) {
            historialTableBody.innerHTML = '';
            data.forEach(item => {
                const row = historialTableBody.insertRow();
                row.insertCell().textContent = item.fecha;
                row.insertCell().textContent = item.aire;
                row.insertCell().textContent = item.tipo;
                row.insertCell().textContent = item.supervisor;
                const fileCell = row.insertCell();
                fileCell.innerHTML = `<a href="${item.archivo}">Ver archivo</a>`;
            });
        }

        historialSearch.addEventListener('keyup', () => {
            const searchTerm = historialSearch.value.toLowerCase();
            const filteredData = maintenanceHistory.filter(item =>
                item.fecha.toLowerCase().includes(searchTerm) ||
                item.aire.toLowerCase().includes(searchTerm) ||
                item.tipo.toLowerCase().includes(searchTerm) ||
                item.supervisor.toLowerCase().includes(searchTerm)
            );
            renderHistorialTable(filteredData);
        });

        renderHistorialTable(maintenanceHistory);

        // --- Gráfica de Mantenimientos (Chart.js) ---
        let maintenanceChart;

        function updateMaintenanceChart() {
            const ctx = document.getElementById('mantenimientoChart').getContext('2d');

            const maintenanceTypes = {};
            maintenanceHistory.forEach(item => {
                maintenanceTypes[item.tipo] = (maintenanceTypes[item.tipo] || 0) + 1;
            });

            const labels = Object.keys(maintenanceTypes);
            const data = Object.values(maintenanceTypes);

            const backgroundColors = [
                'rgba(255, 99, 132, 0.6)', /* Emergencia */
                'rgba(54, 162, 235, 0.6)', /* Preventivo 3 meses */
                'rgba(255, 206, 86, 0.6)', /* Preventivo 6 meses */
                'rgba(75, 192, 192, 0.6)', /* Correctivo */
            ];
            const borderColors = [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
            ];

            if (maintenanceChart) {
                maintenanceChart.destroy();
            }

            maintenanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '# de Mantenimientos',
                        data: data,
                        backgroundColor: labels.map(label => {
                            if (label.includes('Emergencia')) return backgroundColors[0];
                            if (label.includes('Preventivo (3 Meses)')) return backgroundColors[1];
                            if (label.includes('Preventivo (6 Meses)')) return backgroundColors[2];
                            if (label.includes('Correctivo')) return backgroundColors[3];
                            return backgroundColors[0]; // Default
                        }),
                        borderColor: labels.map(label => {
                            if (label.includes('Emergencia')) return borderColors[0];
                            if (label.includes('Preventivo (3 Meses)')) return borderColors[1];
                            if (label.includes('Preventivo (6 Meses)')) return borderColors[2];
                            if (label.includes('Correctivo')) return borderColors[3];
                            return borderColors[0]; // Default
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Tipos de Mantenimiento'
                        }
                    }
                }
            });
        }


        // --- Lógica para Registrar Nuevo Mantenimiento ---
        const registroForm = document.getElementById('registro-form');

        registroForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const fecha = document.getElementById('fechaMantenimiento').value;
            const aire = document.getElementById('aireSeleccionado').value;
            const tipo = document.getElementById('tipoMantenimiento').value;
            const supervisor = document.getElementById('supervisor').value;
            const archivoInput = document.getElementById('archivoMantenimiento');
            const archivo = archivoInput.files.length > 0 ? archivoInput.files[0].name : 'N/A';

            if (fecha && aire && tipo && supervisor) {
                const newMaintenance = {
                    fecha: fecha,
                    aire: aire,
                    tipo: tipo,
                    supervisor: supervisor,
                    archivo: '#'
                };
                maintenanceHistory.push(newMaintenance);
                renderHistorialTable(maintenanceHistory);

                // Lógica para actualizar maintenanceConfigs basado en el nuevo registro
                if (maintenanceConfigs[aire]) {
                    if (tipo === 'Preventivo (3 Meses)') {
                        maintenanceConfigs[aire]['Preventivo (3 Meses)'].lastMaintenanceDate = fecha;
                    } else if (tipo === 'Preventivo (6 Meses)') {
                        maintenanceConfigs[aire]['Preventivo (6 Meses)'].lastMaintenanceDate = fecha;
                    } else if (tipo === 'Correctivo' || tipo === 'Emergencia') {
                        // Si se hace un correctivo o emergencia, reinicia el contador del preventivo de 6 meses
                        maintenanceConfigs[aire]['Preventivo (6 Meses)'].lastMaintenanceDate = fecha;
                    }
                }

                alert('Mantenimiento registrado con éxito: ' + JSON.stringify(newMaintenance));
                registroForm.reset();
                goBackToMantenimiento();
                checkMaintenanceAlerts(); // Re-verifica las alertas después de registrar
            } else {
                alert('Por favor, completa todos los campos obligatorios.');
            }
        });

        // --- Lógica para Planes de Mantenimiento (basado en la imagen) ---
        const selectAirPlan = document.getElementById('selectAirPlan');
        const nextMaintenanceDisplay = document.getElementById('next-maintenance-display');
        const futureMaintenancesDisplay = document.getElementById('future-maintenances-display');

        // Datos de planes de mantenimiento con fechas de ÚLTIMO mantenimiento
        const maintenanceConfigs = {
            'A1': {
                'Preventivo (3 Meses)': { lastMaintenanceDate: '2025-03-01', frequencyMonths: 3, description: 'Revisión ligera, limpieza de filtros pequeños.' },
                'Preventivo (6 Meses)': { lastMaintenanceDate: '2024-12-01', frequencyMonths: 6, description: 'Revisión general, limpieza de filtros grandes, verificación de niveles, lubricación.' }
            },
            'A2': {
                'Preventivo (3 Meses)': { lastMaintenanceDate: '2025-02-15', frequencyMonths: 3, description: 'Revisión ligera, limpieza de filtros pequeños.' },
                'Preventivo (6 Meses)': { lastMaintenanceDate: '2025-01-10', frequencyMonths: 6, description: 'Revisión general, limpieza de filtros grandes, verificación de niveles, lubricación.' }
            }
        };

        // Función auxiliar para calcular la próxima fecha programada y futuras
        function calculateAllUpcomingDates(airId) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const upcomingPlans = [];
            const config = maintenanceConfigs[airId];

            if (!config) return [];

            for (const type in config) {
                const plan = config[type];
                let lastDate = new Date(plan.lastMaintenanceDate + 'T00:00:00'); // Asegurarse de que es la fecha correcta

                // Calcular la próxima fecha programada a partir de la última fecha de mantenimiento
                let nextDate = new Date(lastDate);
                nextDate.setMonth(nextDate.getMonth() + plan.frequencyMonths);

                // Generar futuras ocurrencias si la próxima fecha ya pasó
                while (nextDate < today) {
                    nextDate.setMonth(nextDate.getMonth() + plan.frequencyMonths);
                }

                // Recopilar hasta X futuras ocurrencias (ej. 5-10 para llenar la lista)
                for (let i = 0; i < 5; i++) { // Generar 5 ocurrencias futuras
                    upcomingPlans.push({
                        date: new Date(nextDate),
                        type: type,
                        description: plan.description,
                        air: airId
                    });
                    nextDate.setMonth(nextDate.getMonth() + plan.frequencyMonths);
                }
            }
            // Filtrar las fechas que ya pasaron antes de ordenarlas, exceptuando el próximo si es hoy o atrasado
            // Luego, ordenar por fecha
            upcomingPlans.sort((a, b) => a.date - b.date);

            return upcomingPlans;
        }


        function displayMaintenancePlans() {
            const selectedAir = selectAirPlan.value;
            nextMaintenanceDisplay.innerHTML = '';
            futureMaintenancesDisplay.innerHTML = '';

            if (!selectedAir) {
                nextMaintenanceDisplay.innerHTML = '<p class="text-center">Selecciona un aire para ver sus planes de mantenimiento.</p>';
                futureMaintenancesDisplay.innerHTML = '<p class="text-center">Selecciona un aire para ver sus planes de mantenimiento.</p>';
                return;
            }

            const allUpcomingPlansForAir = calculateAllUpcomingDates(selectedAir);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filtrar solo los planes que aún no han pasado
            const relevantPlans = allUpcomingPlansForAir.filter(plan => plan.date >= today);

            if (relevantPlans.length === 0) {
                nextMaintenanceDisplay.innerHTML = '<p class="text-center">No hay mantenimientos próximos o futuros para este aire.</p>';
                return;
            }

            const nextPlan = relevantPlans[0]; // El más próximo es el primero después de ordenar
            nextMaintenanceDisplay.innerHTML = `
                <div class="single-plan-entry">
                    <div class="plan-date-col">${formatDateToDDMMYYYY(nextPlan.date.toISOString().split('T')[0])}</div>
                    <div class="plan-type-col">${nextPlan.type}</div>
                </div>
            `;
            // Añadir clase de resaltado si está próximo o atrasado
            const nextPlanDateObj = new Date(nextPlan.date);
            const diffTime = nextPlanDateObj - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays >= 0 && diffDays <= 10) {
                nextMaintenanceDisplay.querySelector('.single-plan-entry').classList.add('due-soon');
            } else if (diffDays < 0) {
                nextMaintenanceDisplay.querySelector('.single-plan-entry').classList.add('overdue');
            }


            // Futuros mantenimientos (todos excepto el más próximo)
            if (relevantPlans.length > 1) {
                relevantPlans.slice(1).forEach(plan => {
                    const planDiv = document.createElement('div');
                    planDiv.classList.add('single-plan-entry');

                    const planDateObj = new Date(plan.date);
                    const diffTimeFuture = planDateObj - today;
                    const diffDaysFuture = Math.ceil(diffTimeFuture / (1000 * 60 * 60 * 24));

                    if (diffDaysFuture >= 0 && diffDaysFuture <= 10) {
                        planDiv.classList.add('due-soon');
                    } else if (diffDaysFuture < 0) {
                        planDiv.classList.add('overdue');
                    }

                    planDiv.innerHTML = `
                        <div class="plan-date-col">${formatDateToDDMMYYYY(plan.date.toISOString().split('T')[0])}</div>
                        <div class="plan-type-col">${plan.type}</div>
                    `;
                    futureMaintenancesDisplay.appendChild(planDiv);
                });
            } else {
                futureMaintenancesDisplay.innerHTML = '<p class="text-center">No hay más mantenimientos futuros programados.</p>';
            }
        }


        // --- Lógica para Alertas de Mantenimiento en el Monitor ---
        function checkMaintenanceAlerts() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Ocultar todos los badges primero
            document.getElementById('alert-a1-tools').style.display = 'none';
            document.getElementById('alert-a2-tools').style.display = 'none';

            // Verificar A1
            let a1Alert = false;
            const a1Upcoming = calculateAllUpcomingDates('A1');
            for (const plan of a1Upcoming) {
                const scheduledDate = new Date(plan.date);
                scheduledDate.setHours(0, 0, 0, 0);
                const diffTime = scheduledDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays >= 0 && diffDays <= 10) { // Si está programado para los próximos 10 días o es hoy
                    a1Alert = true;
                    break;
                }
            }
            if (a1Alert) {
                document.getElementById('alert-a1-tools').style.display = 'block';
            }

            // Verificar A2
            let a2Alert = false;
            const a2Upcoming = calculateAllUpcomingDates('A2');
            for (const plan of a2Upcoming) {
                const scheduledDate = new Date(plan.date);
                scheduledDate.setHours(0, 0, 0, 0);
                const diffTime = scheduledDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays >= 0 && diffDays <= 10) {
                    a2Alert = true;
                    break;
                }
            }
            if (a2Alert) {
                document.getElementById('alert-a2-tools').style.display = 'block';
            }
        }


        // Inicializar la vista al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            showSection(monitorSection);
            monitorTab.classList.add('active');
            updateMaintenanceChart();
            // No llamar displayMaintenancePlans aquí directamente, se llamará al seleccionar un aire
            checkMaintenanceAlerts(); // Llama a la función de alerta al inicio
        });

        // Simulación de actualización de temperatura y estado (puedes reemplazar con datos reales)
        function updateMonitorData() {
            const tempElement = document.getElementById('current-temperature');
            const statusA1 = document.getElementById('status-a1');
            const statusA2 = document.getElementById('status-a2');

            const currentTemp = (Math.random() * (28 - 20) + 20).toFixed(1);
            tempElement.textContent = currentTemp;

            if (Math.random() > 0.5) {
                statusA1.textContent = 'Encendido';
                statusA1.classList.remove('text-danger');
                statusA1.classList.add('text-success');
            } else {
                statusA1.textContent = 'Apagado';
                statusA1.classList.remove('text-success');
                statusA1.classList.add('text-danger');
            }

            if (Math.random() > 0.3) {
                statusA2.textContent = 'Encendido';
                statusA2.classList.remove('text-danger');
                statusA2.classList.add('text-success');
            } else {
                statusA2.textContent = 'Apagado';
                statusA2.classList.remove('text-success');
                statusA2.classList.add('text-danger');
            }
            checkMaintenanceAlerts(); // Vuelve a verificar las alertas con cada actualización de datos
        }
        setInterval(updateMonitorData, 5000); // Actualiza cada 5 segundos
        updateMonitorData(); // Llama una vez al inicio
    </script>

</body>
</html>